name: Build PureDoc macOS DMG

# è§¦å‘è§„åˆ™ï¼šæ¨é€åˆ° v* æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v1.0.0)
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. å‡†å¤‡ Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10" 
          cache: 'pip'

      # 3. å®‰è£…ç³»ç»Ÿçº§å·¥å…· (ç§»é™¤äº† wgetï¼Œä¸å†éœ€è¦)
      - name: Install System Tools
        run: |
          brew install create-dmg

      # 4. å®‰è£… Python ä¾èµ–
      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt

      # 5. è®¾å®šåŠ¨æ€æ–‡ä»¶å (æ¶æ„-ç³»ç»Ÿ-ç‰ˆæœ¬)
      - name: Set Output Filename
        id: filename
        run: |
          ARCH=$(uname -m)
          VERSION=${{ github.ref_name }}
          NAME="PureDoc-Installer-${ARCH}-macos-${VERSION}.dmg"
          
          echo "Calculated DMG Name: $NAME"
          echo "DMG_NAME=$NAME" >> $GITHUB_ENV

      # 6. è‡ªåŠ¨ç”Ÿæˆ icon.icns (ç”¨äº DMG å·æ ‡å›¾æ ‡)
      - name: Generate ICNS from PNG
        run: |
          mkdir pure_icon.iconset
          sips -z 16 16     assets/icon.png --out pure_icon.iconset/icon_16x16.png
          sips -z 32 32     assets/icon.png --out pure_icon.iconset/icon_16x16@2x.png
          sips -z 32 32     assets/icon.png --out pure_icon.iconset/icon_32x32.png
          sips -z 64 64     assets/icon.png --out pure_icon.iconset/icon_32x32@2x.png
          sips -z 128 128   assets/icon.png --out pure_icon.iconset/icon_128x128.png
          sips -z 256 256   assets/icon.png --out pure_icon.iconset/icon_128x128@2x.png
          sips -z 256 256   assets/icon.png --out pure_icon.iconset/icon_256x256.png
          sips -z 512 512   assets/icon.png --out pure_icon.iconset/icon_256x256@2x.png
          sips -z 512 512   assets/icon.png --out pure_icon.iconset/icon_512x512.png
          
          iconutil -c icns pure_icon.iconset -o assets/icon.icns
          rm -rf pure_icon.iconset
          echo "âœ… icon.icns generated successfully!"

      # 7. æ‰§è¡Œ Flet Build
      # æ³¨æ„ï¼šè¿™é‡Œå¢åŠ äº† include-packages ç¡®ä¿æ–°ä¾èµ–è¢«æ‰“åŒ…
      - name: Build Flet App
        working-directory: ./
        run: |
          flet build macos \
            --yes \
            --module-name main \
            --description "Markdown to Word Converter" \
            --copyright "Copyright (c) 2024 Jay" \

      # 8. æ¸…ç†æ— æ•ˆè½¯é“¾æ¥ (ä¿®å¤ xattr æŠ¥é”™)
      - name: Cleanup Broken Symlinks
        run: |
            echo "ğŸ” Scanning for broken symlinks in App Bundle..."
            
            APP_PATH="build/macos/PureDoc.app"
            
            if [ -d "$APP_PATH" ]; then
                # åˆ é™¤æ­»é“¾
                find "$APP_PATH" -type l ! -exec test -e {} \; -print -delete
                # åˆ é™¤ .pod æ®‹ç•™
                find "$APP_PATH" -name ".pod" -delete
                
                echo "âœ… Cleanup complete."
            else
                echo "âŒ Error: App path not found at $APP_PATH"
                exit 1
            fi

      # 9. åˆ¶ä½œ DMG é•œåƒ
      - name: Create DMG
        run: |
          mkdir -p dist
          mv build/macos/PureDoc.app dist/
          
          create-dmg \
            --volname "PureDoc Installer" \
            --volicon "assets/icon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "PureDoc.app" 150 190 \
            --hide-extension "PureDoc.app" \
            --app-drop-link 450 185 \
            "${{ env.DMG_NAME }}" \
            "dist/PureDoc.app"

      # 10. å‘å¸ƒåˆ° Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.DMG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}