name: Build PureDoc macOS DMG

# è§¦å‘è§„åˆ™ï¼šæ¨é€åˆ° v* æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v1.0.0)
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. å‡†å¤‡ Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10" 
          cache: 'pip'

      # 3. å®‰è£…ç³»ç»Ÿçº§å·¥å…·
      - name: Install System Tools
        run: |
          brew install create-dmg
          brew install wget 

      # 4. å®‰è£… Python ä¾èµ–
      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt

      # 5. [åŠŸèƒ½] è®¾å®šåŠ¨æ€æ–‡ä»¶å (æ¶æ„-ç³»ç»Ÿ-ç‰ˆæœ¬)
      # è¿™ä¸€æ­¥è®¡ç®—å‡ºæœ€ç»ˆçš„æ–‡ä»¶åï¼Œå­˜å…¥ç¯å¢ƒå˜é‡ DMG_NAME
      - name: Set Output Filename
        id: filename
        run: |
          # è·å–æ¶æ„ (x86_64 æˆ– arm64)
          ARCH=$(uname -m)
          # è·å–ç‰ˆæœ¬å· (ä¾‹å¦‚ v1.0.0)
          VERSION=${{ github.ref_name }}
          # æ‹¼æ¥æ–‡ä»¶å
          NAME="PureDoc-Installer-${ARCH}-macos-${VERSION}.dmg"
          
          echo "Calculated DMG Name: $NAME"
          # å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "DMG_NAME=$NAME" >> $GITHUB_ENV

      # 6. [å…³é”®] è‡ªåŠ¨ç”Ÿæˆ icon.icns (ç”¨äº DMG å·æ ‡å›¾æ ‡)
      - name: Generate ICNS from PNG
        run: |
          mkdir pure_icon.iconset
          sips -z 16 16     assets/icon.png --out pure_icon.iconset/icon_16x16.png
          sips -z 32 32     assets/icon.png --out pure_icon.iconset/icon_16x16@2x.png
          sips -z 32 32     assets/icon.png --out pure_icon.iconset/icon_32x32.png
          sips -z 64 64     assets/icon.png --out pure_icon.iconset/icon_32x32@2x.png
          sips -z 128 128   assets/icon.png --out pure_icon.iconset/icon_128x128.png
          sips -z 256 256   assets/icon.png --out pure_icon.iconset/icon_128x128@2x.png
          sips -z 256 256   assets/icon.png --out pure_icon.iconset/icon_256x256.png
          sips -z 512 512   assets/icon.png --out pure_icon.iconset/icon_256x256@2x.png
          sips -z 512 512   assets/icon.png --out pure_icon.iconset/icon_512x512.png
          
          # ç”Ÿæˆ icns æ–‡ä»¶åˆ° assets/icon.icns
          iconutil -c icns pure_icon.iconset -o assets/icon.icns
          rm -rf pure_icon.iconset
          echo "âœ… icon.icns generated successfully!"

      # 7. [å…³é”®] ä¸‹è½½å¹¶æ¤å…¥ Pandoc äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Embed Pandoc Binary
        run: |
          mkdir -p assets/bin
          wget https://github.com/jgm/pandoc/releases/download/3.1.11.1/pandoc-3.1.11.1-x86_64-macOS.zip -O pandoc.zip
          unzip pandoc.zip
          mv pandoc-*/bin/pandoc assets/bin/pandoc
          chmod +x assets/bin/pandoc
          rm -rf pandoc.zip pandoc-*
          echo "âœ… Pandoc binary embedded into assets/bin/pandoc"

      # 8. æ‰§è¡Œ Flet Build
      - name: Build Flet App
        working-directory: ./
        run: |
          flet build macos \
            --yes \
            --module-name main \
            --description "Markdown to Word Converter" \
            --copyright "Copyright (c) 2024 Jay" 

      # 9. æ¸…ç†æ— æ•ˆè½¯é“¾æ¥ (ä¿®å¤ xattr æŠ¥é”™)
      - name: Cleanup Broken Symlinks
        run: |
            echo "ğŸ” Scanning for broken symlinks in App Bundle..."
            find build/macos/PureDoc.app -type l ! -exec test -e {} \; -print -delete
            echo "âœ… Cleanup complete."

      # 10. åˆ¶ä½œ DMG é•œåƒ (ä½¿ç”¨åŠ¨æ€æ–‡ä»¶å)
      - name: Create DMG
        run: |
          # å‡†å¤‡è¾“å‡ºç›®å½•
          mkdir -p dist
          mv build/macos/PureDoc.app dist/
          
          # ç¡®ä¿å›¾æ ‡å­˜åœ¨
          ls -l assets/icon.icns
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„æ–‡ä»¶å
          create-dmg \
            --volname "PureDoc Installer" \
            --volicon "assets/icon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "PureDoc.app" 150 190 \
            --hide-extension "PureDoc.app" \
            --app-drop-link 450 185 \
            "${{ env.DMG_NAME }}" \
            "dist/PureDoc.app"

      # 11. å‘å¸ƒåˆ° Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.DMG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}